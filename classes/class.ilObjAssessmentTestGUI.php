<?php

use Fluxlabs\Assessment\Test\Leipzig\LeipzigTest;
use Fluxlabs\Assessment\Tools\Domain\ILIASReference;
use ILIAS\Data\UUID\Factory;
use ILIAS\Data\UUID\Uuid;
use srag\DIC\AssessmentTest\DICTrait;
use srag\Plugins\AssessmentTest\Utils\AssessmentTestTrait;
use srag\asq\Application\Service\ASQDIC;
use srag\asq\Infrastructure\Persistence\QuestionType;
use srag\asq\Infrastructure\Setup\lang\SetupAsqLanguages;
use srag\asq\Infrastructure\Setup\sql\SetupDatabase;

/**
 * Class ilObjAssessmentTestGUI
 *
 * Generated by SrPluginGenerator v1.3.5
 *
 * @author studer + raimann ag - Adrian LÃ¼thi <al@studer-raimann.ch>
 *
 * @ilCtrl_isCalledBy ilObjAssessmentTestGUI: ilRepositoryGUI
 * @ilCtrl_isCalledBy ilObjAssessmentTestGUI: ilObjPluginDispatchGUI
 * @ilCtrl_isCalledBy ilObjAssessmentTestGUI: ilAdministrationGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: ilPermissionGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: ilInfoScreenGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: ilObjectCopyGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: ilCommonActionDispatcherGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: AsqQuestionAuthoringGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: TestPlayerGUI
 * @ilCtrl_Calls      ilObjAssessmentTestGUI: QuestionPoolSelectionGUI
 */
class ilObjAssessmentTestGUI extends ilObjectPluginGUI
{
    use DICTrait;
    use AssessmentTestTrait;
    const PLUGIN_CLASS_NAME = ilAssessmentTestPlugin::class;
    const LANG_MODULE_OBJECT = "object";

    private LeipzigTest $test;

    private Factory $uuid_factory;

    /**
     * @inheritDoc
     */
    protected function afterConstructor()/*: void*/
    {
        global $DIC;

        ASQDIC::initiateASQ($DIC);

        $this->uuid_factory = new Factory();

        $this->loadTest();
    }

    private function loadTest() : void
    {
        if ($this->object === null) {
            return;
        }

        $raw_test_id = $this->object->getData();

        if (is_null($raw_test_id)) {
            $this->createNewTest();
        }
        else {
            $this->test = LeipzigTest::load($this->createReference($this->uuid_factory->fromString($raw_test_id)));
        }
    }

    private function createNewTest() : void
    {
        $test_id = $this->uuid_factory->uuid4();
        $this->object->setData($test_id->toString());
        $this->object->doUpdate();

        $this->test = LeipzigTest::create($this->createReference($test_id), $this->object->getTitle(), $this->object->getDescription());
    }

    private function createReference(Uuid $id) : ILIASReference
    {
        return new ILIASReference($id, $this->object->getType(), $this->object_id);
    }

    /**
     * @inheritDoc
     */
    final public function getType() : string
    {
        return ilAssessmentTestPlugin::PLUGIN_ID;
    }

    public function performCommand(string $cmd)/*: void*/
    {
        $this->test->executeCommand($cmd);
        $this->show();
    }

    /**
     * @param string $html
     */
    protected function show()/*: void*/
    {
        foreach ($this->test->ui()->getTabs() as $tab) {
            self::dic()->tabs()->addTab(
                $tab->getId(),
                $tab->getText(),
                self::dic()->ctrl()->getLinkTarget($this, $tab->getLink())
            );

            if($tab->isActive()) {
                self::dic()->tabs()->activateTab($tab->getId());
            }
        }

        foreach ($this->test->ui()->getToolbar() as $tool) {
            self::dic()->toolbar()->addComponent($tool);
        }

        self::dic()->ui()->mainTemplate()->setTitle($this->test->ui()->getTitle());

        self::dic()->ui()->mainTemplate()->setDescription($this->test->ui()->getDescription());

        self::output()->output($this->test->ui()->getContent());
    }


    /**
     * @inheritDoc
     */
    public function initCreateForm(/*string*/ $a_new_type) : ilPropertyFormGUI
    {
        $form = parent::initCreateForm($a_new_type);

        return $form;
    }


    /**
     * @inheritDoc
     *
     * @param ilObjAssessmentTest $a_new_object
     */
    public function afterSave(/*ilObjAssessmentTest*/ ilObject $a_new_object)/*: void*/
    {
        parent::afterSave($a_new_object);
    }

    /**
     * @return string
     */
    public static function getStartCmd() : string
    {
        return LeipzigTest::getInitialCommand();
    }

    /**
     * @inheritDoc
     */
    public function getAfterCreationCmd() : string
    {
        return self::getStartCmd();
    }


    /**
     * @inheritDoc
     */
    public function getStandardCmd() : string
    {
        return self::getStartCmd();
    }
}
